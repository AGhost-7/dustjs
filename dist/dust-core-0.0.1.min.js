//
// Dust - Asynchronous Templating v0.0.1
// http://akdubya.github.com/dustjs
//
// Copyright (c) 2010, Aleksander Williams
// Released under the MIT License.
//

var dust={};
(function(d){function g(a,b,c){this.stack=a;this.global=b;this.blocks=c}function j(a,b,c,e){this.tail=b;this.isObject=!d.isArray(a)&&a&&typeof a==="object";this.head=a;this.index=c;this.of=e}function m(a){this.head=new f(this);this.callback=a;this.out=""}function k(){this.head=new f(this)}function f(a,b,c){this.root=a;this.next=b;this.data="";this.flushable=false;this.taps=c}function l(a,b){this.head=a;this.tail=b}d.cache={};d.register=function(a,b){d.cache[a]=b};d.render=function(a,b,c){c=(new m(c)).head;
d.load(a,c,g.wrap(b)).end()};d.stream=function(a,b){var c=new k;setTimeout(function(){d.load(a,c.head,g.wrap(b)).end()});return c};d.load=function(a,b,c){return(tmpl=d.cache[a])?tmpl(b,c):b.setError(Error("Template Not Found: "+a))};d.loadSource=function(a){eval(a)};d.isArray=Array.isArray?Array.isArray:function(a){return Object.prototype.toString.call(a)=="[object Array]"};d.nextTick=function(a){setTimeout(a,0)};d.isEmpty=function(a){if(d.isArray(a)&&!a.length)return true;if(a===0)return false;return!a};
d.filter=function(a,b,c){for(var e=c.length,h=0;h<e;h++){var i=c[h];if(i==="s")b=null;else a=d.filters[i](a)}if(b)a=d.filters[b](a);return a};d.filters={h:function(a){return d.escapeHtml(a)},j:function(a){return d.escapeJs(a)},u:encodeURI,uc:encodeURIComponent};g.base=function(a){return new g(new j,a)};g.wrap=function(a){if(a instanceof g)return a;return new g(new j(a))};g.prototype.get=function(a){for(var b=this.stack,c;b;){if(b.isObject){c=b.head[a];if(c!==undefined)return c}b=b.tail}return this.global?
this.global[a]:undefined};g.prototype.getPath=function(a,b){var c=this.stack,e=b.length;if(a&&e===0)return c.head;if(c.isObject){c=c.head;for(var h=0;c&&h<e;){c=c[b[h]];h++}return c}};g.prototype.push=function(a,b,c){return new g(new j(a,this.stack,b,c),this.global,this.blocks)};g.prototype.rebase=function(a){return new g(new j(a),this.global,this.blocks)};g.prototype.current=function(){return this.stack.head};g.prototype.getBlock=function(a){var b=this.blocks;if(b)for(var c=b.length,e;c--;)if(e=
b[c][a])return e};g.prototype.shiftBlocks=function(a){var b=this.blocks;if(a){newBlocks=b?b.concat([a]):[a];return new g(this.stack,this.global,newBlocks)}return this};m.prototype.flush=function(){for(var a=this.head;a;){if(a.flushable)this.out+=a.data;else{if(a.error){this.callback(a.error);this.flush=function(){}}return}this.head=a=a.next}this.callback(null,this.out)};k.prototype.flush=function(){for(var a=this.head;a;){if(a.flushable)this.emit("data",a.data);else{if(a.error){this.emit("error",
a.error);this.flush=function(){}}return}this.head=a=a.next}this.emit("end")};k.prototype.emit=function(a,b){var c=this.events;c&&c[a]&&c[a](b)};k.prototype.on=function(a,b){if(!this.events)this.events={};this.events[a]=b;return this};f.prototype.write=function(a){var b=this.taps;if(b)a=b.go(a);this.data+=a;return this};f.prototype.end=function(a){a&&this.write(a);this.flushable=true;this.root.flush();return this};f.prototype.map=function(a){var b=new f(this.root,this.next,this.taps),c=new f(this.root,
b,this.taps);this.next=c;this.flushable=true;a(c);return b};f.prototype.tap=function(a){var b=this.taps;this.taps=b?b.push(a):new l(a);return this};f.prototype.untap=function(){this.taps=this.taps.tail;return this};f.prototype.render=function(a,b){return a(this,b)};f.prototype.reference=function(a,b,c,e){if(typeof a==="function"){a=a(this,b,null,{auto:c,filters:e});if(a instanceof f)return a}return d.isEmpty(a)?this:this.write(d.filter(a,c,e))};f.prototype.section=function(a,b,c,e){if(typeof a===
"function"){a=a(this,b,c,e);if(a instanceof f)return a}var h=c.block;c=c["else"];if(e)b=b.push(e);if(d.isArray(a)){if(h){e=a.length;c=this;for(var i=0;i<e;i++)c=h(c,b.push(a[i],i,e));return c}}else if(a===true){if(h)return h(this,b)}else if(a||a===0){if(h)return h(this,b.push(a))}else if(c)return c(this,b);return this};f.prototype.exists=function(a,b,c){var e=c.block;c=c["else"];if(d.isEmpty(a)){if(c)return c(this,b)}else if(e)return e(this,b);return this};f.prototype.notexists=function(a,b,c){var e=
c.block;c=c["else"];if(d.isEmpty(a)){if(e)return e(this,b)}else if(c)return c(this,b);return this};f.prototype.block=function(a,b,c){c=c.block;if(a)c=a;if(c)return c(this,b);return this};f.prototype.partial=function(a,b){if(typeof a==="function")return this.capture(a,b,function(c,e){d.load(c,e,b).end()});return d.load(a,this,b)};f.prototype.helper=function(a,b,c,e){return d.helpers[a](this,b,c,e)};f.prototype.capture=function(a,b,c){return this.map(function(e){var h=new m(function(i,n){i?e.setError(i):
c(n,e)});a(h.head,b).end()})};f.prototype.setError=function(a){this.error=a;this.root.flush();return this};d.helpers={sep:function(a,b,c){if(b.stack.index===b.stack.of-1)return a;return c.block(a,b)},idx:function(a,b,c){return c.block(a,b.push(b.stack.index))}};l.prototype.push=function(a){return new l(a,this)};l.prototype.go=function(a){for(var b=this;b;){a=b.head(a);b=b.tail}return a};var o=/[&<>\"]/,p=/&/g,q=/</g,r=/>/g,s=/\"/g;d.escapeHtml=function(a){if(typeof a==="string"){if(!o.test(a))return a;
return a.replace(p,"&amp;").replace(q,"&lt;").replace(r,"&gt;").replace(s,"&quot;")}return a};var t=/\\/g,u=/\r/g,v=/\u2028/g,w=/\u2029/g,x=/\n/g,y=/\f/g,z=/'/g,A=/"/g,B=/\t/g;d.escapeJs=function(a){if(typeof a==="string")return a.replace(t,"\\\\").replace(A,'\\"').replace(z,"\\'").replace(u,"\\r").replace(v,"\\u2028").replace(w,"\\u2029").replace(x,"\\n").replace(y,"\\f").replace(B,"\\t");return a}})(dust);if(typeof exports!=="undefined"){require("./server")(dust);module.exports=dust};
